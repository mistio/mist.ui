<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/3.8.5/echarts.min.js" integrity="sha256-7aRWxAaH0PFLbAt5oJLWIliWFHPZWuFbCGchtzd6njk=" crossorigin="anonymous"></script>

<dom-module id="balance-chart">
    <template>
        <style is="custom-style" include="shared-styles">
        :host {
            display: block;
        }

        :host paper-material {
            display: block;
            padding: 0;
        }
        .balance {
            font-size: 2em;
        }
        .balance sub,
        .balance sup {
            font-size: .6em;
            font-weight: 300;
        }
        .balance sub {
            vertical-align: baseline;
        }
        .navigator {
            display: flex;
        }
        .navigator paper-button {
            font-size: .9em;
            background-color: #eee !important;
            margin: 8px !important;
        }
        .navigator paper-button.active{
            color: var(--accent-color) !important;
        }
        #balanceGraph {
            height: 300px;
            margin-bottom: 40px;
        }
        </style>

        <div id="balanceGraph" style$="height:300px; width:[[balanceGraphWidth]]px;"></div>
        <iron-ajax id="getBalance" auto url="/api/v1/metering" method="GET" loading="{{loadingMetering}}" on-response="_handleMeteringResponse" on-error="_handleMeteringError"></iron-ajax>
    </template>
    <script>
BALANCE_GRAPH_OPTIONS = {
    title: {
        text: 'Balance'
    },
    tooltip: {
        trigger: 'axis',
        extraCssText: 'text-align: left',
        formatter: function (params, ticket, callback) {
            var title = '<strong><sup>$</sup>'+params[0].data[1]+' on '+moment(params[0].data[0]).format('DD MMM')+ '</strong><br />',
                vcpus = '<sup>$</sup>'+params[0].data[2]+' for '+params[0].data[3]+' extra vcpus<br />',
                datapoints = '<sup>$</sup>'+params[0].data[4]+' for '+params[0].data[5]+' extra datapoints<br />',
                checks = '<sup>$</sup>'+params[0].data[6]+' for ' +params[0].data[7]+' extra rule checks<br />',
                requests = '<sup>$</sup>'+params[0].data[8]+' for ' +params[0].data[9]+' for extra apicall requests';
            return title + vcpus + datapoints + checks + requests;
        }
    },
    grid: {
        left: '3%',
        right: '4%',
        bottom: '3%',
        containLabel: true
    },
    toolbox: {
        show: true,
        feature: {
            saveAsImage: {
                title: 'Save image'
            }
        },
    },
    legend: {
        show: true,
    },
    xAxis: {
        type: 'time',
        splitLine: {
            show: false
        },
        data: []
    },
    yAxis: {
        type: 'value',
        axisLabel: {
            formatter: '${value}'
        }
    },
    series: [
        {
            name:'cost',
            type:'line',
            data:[],
        }
    ]
};


        Polymer({
            is: 'balance-chart',
            behaviors: [
                Polymer.IronResizableBehavior
            ],

            properties: {
                isOverUsing: Boolean,
                user: {
                    type: Object
                },
                org: {
                    type: Object
                },
                plans: {
                    type: Array,
                    computed: 'computePlans(user, org)'
                },
                balanceGraph: Object,
                balanceGraphOptions: {
                    type: Object,
                    value: function() {
                        return BALANCE_GRAPH_OPTIONS;
                    }
                },
                balanceData: Object,
                data: {
                    type: Array,
                    computed: '_computeData(balanceData)'
                },
                balanceGraphWidth: {
                    type: Number,
                    value: 300
                }

            },
            listeners: {
                'iron-resize': 'updateChartWidth'
            },
            attached: function(){
                this.initCharts();
                var balanceData = {
                    balance: 124,
                    data: [{  //datetime cost
                            date: moment().subtract(1,'days').toDate(),
                            cost: 10,
                            usage: {
                                vcpus: {total: 110, extra: 5, cost: 10},
                                datapoints: {total: 110,  extra: 0, cost: 0},
                                checks: {total: 110, extra: 0, cost: 0},
                                requests: {total: 110, extra: 0, cost: 0},
                            }
                        },
                        {
                            date: moment().subtract(2,'days').toDate(),
                            cost: 0,
                            usage: {
                                vcpus: {total: 90, extra: 0, cost: 0},
                                datapoints: {total: 110, extra: 0, cost: 0},
                                checks: {total: 110, extra: 0, cost: 0},
                                requests: {total: 110, extra: 0, cost: 0},
                            }
                        },
                        {
                            date: moment().subtract(3,'days').toDate(),
                            cost: 0,
                            usage: {
                                vcpus: {total: 90, extra: 0, cost: 0},
                                datapoints: {total: 110, extra: 0, cost: 0},
                                checks: {total: 110, extra: 0, cost: 0},
                                requests: {total: 110, extra: 0, cost: 0},
                            }
                        },
                        {
                            date: moment().subtract(4,'days').toDate(),
                            cost: 57,
                            usage: {
                                vcpus: {total: 126, extra: 26, cost: 52},
                                datapoints: {total: 110, extra: 135, cost: 5},
                                checks: {total: 110, extra: 0, cost: 0},
                                requests: {total: 110, extra: 0, cost: 0},
                            }
                        },
                        {  //datetime cost
                            date: moment().subtract(5,'days').toDate(),
                            cost: 10,
                            usage: {
                                vcpus: {total: 110, extra: 5, cost: 10},
                                datapoints: {total: 110,  extra: 0, cost: 0},
                                checks: {total: 110, extra: 0, cost: 0},
                                requests: {total: 110, extra: 0, cost: 0},
                            }
                        },
                        {
                            date: moment().subtract(6,'days').toDate(),
                            cost: 0,
                            usage: {
                                vcpus: {total: 90, extra: 0, cost: 0},
                                datapoints: {total: 110, extra: 0, cost: 0},
                                checks: {total: 110, extra: 0, cost: 0},
                                requests: {total: 110, extra: 0, cost: 0},
                            }
                        },
                        {
                            date: moment().subtract(7,'days').toDate(),
                            cost: 0,
                            usage: {
                                vcpus: {total: 90, extra: 0, cost: 0},
                                datapoints: {total: 110, extra: 0, cost: 0},
                                checks: {total: 110, extra: 0, cost: 0},
                                requests: {total: 110, extra: 0, cost: 0},
                            }
                        },
                        {
                            date: moment().subtract(8,'days').toDate(),
                            cost: 57,
                            usage: {
                                vcpus: {total: 126, extra: 26, cost: 52},
                                datapoints: {total: 110, extra: 135, cost: 5},
                                checks: {total: 110, extra: 0, cost: 0},
                                requests: {total: 110, extra: 0, cost: 0},
                            }
                        },
                    ]
                };
                this.set('balanceData', balanceData);
            },
            initCharts: function() {
                var colorPalette = ['#607D8B', '#d96557', '#3F51B5', '#009688', '#795548', '#8c76d1', '#795548', '#0277BD', '#0099cc', '#424242', '#D48900', '#43A047', '#2F2F3E'];
                echarts.registerTheme('balance', {
                    color: colorPalette,
                    backgroundColor: 'transparent',
                    graph: {
                        color: colorPalette
                    }
                });
                this.balanceGraph = echarts.init(this.$.balanceGraph, 'balance');
                this.balanceGraph.setOption(this.balanceGraphOptions);
                this.updateChartWidth();
                console.log('initialized charts');
            },
            updateChartWidth: function() {
                var parentWidth = this.parentNode.offsetWidth;
                console.log('updateChartWidth',parentWidth);
                if (parentWidth) {
                    this.set('balanceGraphWidth', parentWidth);
                    this.resizeGraph();
                }
            },
            resizeGraph: function() {
                console.log('resizeGraph');
                if (this.balanceGraph)
                    this.balanceGraph.resize();
            },
            _computeData: function(balanceData) {
                // var plan = 'Small', 
                //     price = 200, 
                //     monthdays = moment(this.balanceData.data[this.balanceData.data.length-1][0]).daysInMonth();
                var pricePerDay; // = (price/monthdays).toFixed();
                var timeToCost = this.balanceData.data.map(function(d){
                    var cost = pricePerDay ? Math.max(pricePerDay, d.cost) : d.cost;
                    return [d.date, cost, d.usage.vcpus.cost, d.usage.vcpus.extra, d.usage.datapoints.cost, d.usage.datapoints.extra, d.usage.checks.cost, d.usage.checks.extra, d.usage.requests.cost, d.usage.requests.extra]
                });
                var since = moment(timeToCost[timeToCost.length-1][0]).format('DD MMM');
                // this.set('balanceGraphOptions.yAxis.min', (200/30).toFixed());
                this.set('balanceGraphOptions.series.0.data', timeToCost);
                this.set('balanceGraphOptions.title.text', '$'+this.balanceData.balance+' since '+since);
                this.balanceGraph.setOption(this.balanceGraphOptions);
                return timeToCost;
            }
        });
    </script>
</dom-module>
