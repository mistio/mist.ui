<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">

<link rel="import" href="multi-inputs.html">

<dom-module id="details-page">
    <template>
        <style is="custom-style" include="shared-styles forms">
            :host {
                display: block;
            }

            :host paper-material {
                display: block;
                padding: 0;
            }

            label {
                color: rgba(0, 0, 0, 0.54) !important;
                font-size: 12px;
            }

            .grid-row {
                padding: 24px;
            }

            .head {
                margin-bottom: 16px;
            }

            h2.title {
                font-weight: 500;
            }

            h2.title, h2.title~p {
                margin-top: 0;
                margin-bottom: 0;
            }

            paper-radio-button {
                --paper-radio-button-checked-color: var(--paper-light-blue-500);
                --paper-radio-button-checked-ink-color: var(--paper-light-blue-500);
                --paper-radio-button-unchecked-ink-color: var(--paper-light-blue-900);
            }
            hr {
                width: 100%;
            }
            :host paper-progress{
                position: absolute;
                width: 100%;
                left: 0;
                right: 0;
            }
            
            .margin {
                margin: 32px 0;
            }

            .bottom-actions {
                padding-bottom: 24px;
                padding-left: 1rem;
            }
            .separator {
                border-top: 4px solid #ddd;
            }
            .progress {
                margin: 32px 0 8px 0;
                width: 100%;
            }
            paper-progress.progresserror ::content #primaryProgress {
                background-color: var(--red-color);
            }
            .errormsg-container {
                color: var(--red-color);
                padding-left: 24px;
                padding-right: 24px
            }
            .errormsg-container iron-icon {
                color: inherit;
            }

            paper-icon-button.white {
                --paper-icon-button-ink-color: var(--paper-orange-500);
            }

            paper-icon-button.delete-avatar-icon {
                top: -12px;
            }

            iron-image.avatar-preview {
                width: 80px;
                height: 36px;
                margin: 2px 6px;
            }

            div.existing-org-logo {
                display: inline-block;
                vertical-align: middle;
                text-align: center;
            }

            div.org-logo-container {
                background-color: #2F2F3E;
                margin: 6px;
                display: inline-block
            }

            div.org-logo-field-title {
                color: var(--paper-light-blue-600);
                text-transform: uppercase;
                font-weight: 400;
                font-size: 12px;
                margin-left: -17px;
            }

            paper-toggle-button {
                margin: auto;
            }
        </style>
        <paper-material>
            <div class="grid-row">
                <div class="xs12 head">
                    <h2 class="title">User Profile</h2>
                </div>
                <paper-input class="xs12 l6" id="firstName" label="First Name" required error-message="Please enter your first name" value="{{firstName}}" auto-validate></paper-input>

                <paper-input class="xs12 l6" id="lastName" label="Last Name" required error-message="Please enter your last name" value="{{lastName}}" auto-validate></paper-input>

                <paper-input class="xs12 l6" id="email" label="Email *" required error-message="Please enter your email" value="[[user.email]]" auto-validate disabled></paper-input>
                <p class="xs12 l12">* Currently you cannot change your account's email for security reasons. Please contact us at <a href="mailto:support@mist.io">support@mist.io</a>, if you wish to do so.</p>

                <div class="progress">
                    <paper-progress id="userProgress" indeterminate hidden$="[[!loadingUser]]"></paper-progress>
                    <paper-progress id="userprogresserror" class="progresserror" value="100" hidden$="[[!userError]]"></paper-progress>
                    <hr class="appform"/>
                    <p id="userprogressmessage" class="errormsg-container" hidden$="[[!userError]]"><iron-icon icon="icons:error-outline"></iron-icon><span id="usererrormsg"></span></p>
                </div>

                <div class="bottom-actions clearfix xs12">
                    <paper-button class="pull-right" disabled$="[[!userFormReady]]" raised on-tap="_submitUserForm" page="second">Save User Profile</paper-button>
                    <iron-ajax id="userAjaxRequest"
                        url="/api/v1/account"
                        method="POST"
                        loading="{{loadingUser}}"
                        on-response="_handleAjaxResponse"
                        on-error="_handleDetailsAjaxError"
                        handle-as="xml"></iron-ajax>
                </div>
            </div>
        </paper-material>
        <paper-material class="separator">
            <div class="grid-row">
                <div class="xs12 head">
                    <h2 class="title">IP whitelisting</h2>
                </div>
                <div class="ips-section xs12 m12 l12">
                    <p>Allow account access to whitelisted ips only. You can use cidr format.</p>
                    <multi-inputs with-description with-confirm-remove
                        input-label="cidr" 
                        inputs-array="{{whiteIps}}" 
                        event-name="save-ips"></multi-inputs>
                </div>
                
                <div class="progress">
                    <paper-progress id="ipProgress" indeterminate hidden$="[[!loadingIp]]"></paper-progress>
                    <paper-progress id="ipprogresserror" class="progresserror" value="100" hidden$="[[!ipError]]"></paper-progress>
                    <hr class="appform"/>
                    <p id="iprprogressmessage" class="errormsg-container" hidden$="[[!ipError]]"><iron-icon icon="icons:error-outline"></iron-icon><span id="iperrormsg"></span></p>
                </div>

                <div class="bottom-actions clearfix xs12">
                    <paper-button class="pull-right" on-tap="_saveWhitelist" raised disabled$="[[!ipsFormReady]]">Save IPs</paper-button>
                    <paper-button class="pull-right" on-tap="addCurrentIP" hidden$="[[!showAddCurrent]]">Add your current IP: [[user.current_ip]]</paper-button>

                    <iron-ajax id="ipsRequest"
                        url="/api/v1/users/whitelist"
                        method="PUT"
                        handle-as="xml"
                        loading="{{loadingIp}}"
                        on-response="handleIpResponse"
                        on-error="handleIpError"></iron-ajax>

                </div>
            </div>
        </paper-material>
        <paper-material class="separator">
            <div class="grid-row" hidden$="[[!org.is_owner]]">
                <div class="xs12 head">
                    <h2 class="title">Organisation Profile</h2>
                    <p>Enter your organisation details. To switch organisation use the  user menu in the top right corner of your screen.</p>
                </div>
                <paper-input class="dropdown-block xs12 l6" id="orgName" label="Organization Name" required error-message="Please enter your company's name" value="{{orgName}}" auto-validate disabled$="[[!org.is_owner]]"></paper-input>

                <paper-textarea class="xs12 l6" id="org-email" label="Organisation Alert Email *" error-message="Please enter your email" value="{{orgAlertEmails}}" auto-validate></paper-textarea>

                <p class="xs12 l12">* In your organisation's alert email, you can specify the email you want your incidents' alerts to be sent to. This can be overriden when you add rules in your monitored machines.</p>

                <div class="xs12 head">
                    <div hidden$="[[!org.avatar]]" class="existing-org-logo">
                        <div class="org-logo-field-title">Organisation logo</div>
                        <div>
                            <div class="org-logo-container">
                                <iron-image src$="[[_computeAvatarURL(org.avatar)]]" fades sizing="contain" class="avatar-preview"></iron-image>
                            </div>
                            <paper-icon-button icon="close" on-tap="_deleteAvatar" class="delete-avatar-icon"></paper-icon-button>
                        </div>
                    </div>
                    <div hidden$="[[org.avatar.length]]">
                        <div class="xs12 org-logo-field-title margin">Custom Logo</div>
                        <paper-toggle-button checked="{{customLogo}}">
                            Enable account custom logo.
                        </paper-toggle-button>
                        <div hidden$="[[!customLogo]]">
                            <p class="xs12 l12">Upload an image that will override the default mist.io logo</p>
                            <vaadin-upload id="orgAvatarUpload" max-files="1" accept="image/png" max-file-size="262144"
                                headers="[[_computeUploadHeaders()]]"
                                target="/api/v1/avatars">
                                <div class="drop-label">
                                    <iron-icon icon="file-upload"></iron-icon>
                                    Drop file here - PNG up to 256kb
                                </div>
                                <div class="org-logo-container">
                                    <iron-image src$="[[_computeAvatarURL(orgAvatar)]]" fades hidden$="[[!orgAvatar]]" sizing="contain" class="avatar-preview"></iron-image>
                                </div>
                            </vaadin-upload>
                        </div>
                    </div>
                </div>

                <div class="progress">
                    <paper-progress id="orgProgress" indeterminate hidden$="[[!loadingOrg]]"></paper-progress>
                    <paper-progress id="orgprogresserror" class="progresserror" value="100" hidden$="[[!orgError]]"></paper-progress>
                    <hr class="appform"/>
                    <p id="orgprogressmessage" class="errormsg-container" hidden$="[[!orgError]]"><iron-icon icon="icons:error-outline"></iron-icon><span id="orgerrormsg"></span></p>
                </div>

                <div class="bottom-actions clearfix xs12">
                    <paper-button class="pull-right" disabled$="[[!orgFormReady]]" raised on-tap="_submitOrgForm" page="second">Save Organisation Profile</paper-button>
                    <iron-ajax id="orgAjaxRequest"
                        url="/api/v1/org/[[org.id]]"
                        method="PUT"
                        loading="{{loadingOrg}}"
                        on-response="_handleAjaxResponse"
                        on-error="_handleOrgAjaxError"
                        handle-as="xml"></iron-ajax>
                </div>
            </div>

            <div class="grid-row" hidden$="[[org.is_owner]]">
              <div class="xs12 head">
                  <h2 class="title">Organisation</h2>
                  <p>You are operating as a member of <strong>[[org.name]]</strong>. To switch between organisations use the user menu in the top right corner of your screen.</p>
              </div>
            </div>

        </paper-material>
    </template>
    <script>
        (function() {
            'use strict';

            Polymer({
                is: 'details-page',

                properties: {
                    org: {
                        type: Object
                    },
                    user: {
                        type: Object,
                    },
                    firstName: {
                        type: String
                    },
                    lastName: {
                        type: String
                    },
                    orgName: {
                        type: String
                    },
                    orgAlertEmails: {
                        type: String,
                    },
                    ipsFormReady: {
                        type: Boolean,
                        computed: '_computIpFormReady(user, whiteIps, whiteIps.length)'
                    },
                    userFormReady: {
                        type: Boolean,
                        computed: '_computeUserFormReady(firstName, lastName, loadingUser, user)'
                    },
                    orgFormReady: {
                        type: Boolean,
                        computed: '_computeOrgFormReady(orgName, orgAlertEmails, orgAvatar, loadingOrg, org)'
                    },
                    loadingUser: {
                        type: Boolean,
                        value: false
                    },
                    userError: {
                        type: Boolean,
                        value: false
                    },
                    loadingOrg: {
                        type: Boolean,
                        value: false
                    },
                    orgError: {
                        type: Boolean,
                        value: false
                    },
                    loadingIp: {
                        type: Boolean,
                        value: false
                    },
                    ipError: {
                        type: Boolean,
                        value: false
                    },
                    orgAvatar: {
                        type: String,
                        value: ''
                    },
                    customLogo: false,
                    whiteIps: {
                        type: Array
                    },
                    showAddCurrent: {
                        type: Boolean,
                        value: false
                    }
                },
                observers: [
                    '_userUpdated(user)',
                    '_orgUpdated(org)',
                    '_showAddCurrent(whiteIps.length, user.current_ip)'
                ],

                attached: function() {
                    var that = this;
                    this.$.orgAvatarUpload.addEventListener('upload-response', function(e) {
                        if (e.detail.xhr.status == 200) {
                            that.orgAvatar = JSON.parse(e.detail.xhr.response).id;
                        }
                    });
                    this.$.orgAvatarUpload.addEventListener('file-remove', function(e) {
                        that.orgAvatar = '';
                    });
                },

                _saveWhitelist: function(e){
                    console.log('save Whitelist')
                    // TODO save ips
                    var payload = {
                        ips: this.whiteIps.filter(function(p){return p.cidr && p.cidr.trim() != ''})
                    };

                    this.$.ipsRequest.headers["Content-Type"] = 'application/json';
                    this.$.ipsRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                    this.$.ipsRequest.body = payload;
                    console.log('_saveWhitelist',payload)
                    this.$.ipsRequest.generateRequest();
                },

                addCurrentIP: function(e){
                    this.push('whiteIps', {cidr: this.user.current_ip, description: "Current ip"});
                },

                _showAddCurrent: function(ips, currentIp){
                    if (this.whiteIps && this.whiteIps.length)
                        var isInArray = this.whiteIps.find(function(p){ return p.cidr == currentIp});
                    this.set('showAddCurrent', isInArray ? false : true);
                },

                _userUpdated: function(user) {
                    // TODO set user.ips
                    //test code
                    // this.set("user.current_ip",'1.1.1.1');
                    // this.whiteIps = user.ips || [{cidr:'2.2.2.2', description:''},{cidr:'3.3.3.3', description:''}];
                    
                    this.whiteIps = user.ips || [];
                    this.firstName = user.first_name;
                    this.lastName = user.last_name;
                },

                _orgUpdated: function(org) {
                    this.orgName = org.name;
                    this.orgAlertEmails = org.alerts_email.join('\n')
                    this.customLogo = org.avatar ? true : false
                },

                _computeUploadHeaders: function() {
                    return {'Csrf-Token': CSRF_TOKEN, 'Accept': 'application/json'};
                },

                _deleteAvatar: function(event) {
                    var xhr = new XMLHttpRequest();
                    xhr.open("DELETE", "/api/v1/avatars/" + this.org.avatar);
                    xhr.setRequestHeader("Csrf-Token", CSRF_TOKEN);
                    xhr.send();
                    this.orgAvatar = '';
                    this.$.orgAvatarUpload.files = [];
                },

                _computIpFormReady: function(user){
                    // TODO: set || []
                    var currentUserIps = this.user.ips || [],
                        formIps = this.whiteIps ? this.whiteIps.filter(function(p){return p.cidr && p.cidr.trim() != ''}) : [];

                    if (currentUserIps.length != formIps.length)
                        return true;
                    else {
                        // check if there are changes
                        for (var i = 0; i < formIps.length; i++) {
                            if (formIps[i].cidr != currentUserIps[i].cidr || formIps[i].description != currentUserIps[i].description )
                                return true
                        }
                    }
                    return false;
                },

                _computeUserFormReady: function(firstName, lastName, loading, user) {
                    if (loading || !user)
                        return false;

                    if (firstName == user.first_name && lastName == user.last_name)
                        return false;

                    if (firstName && lastName)
                        return true;

                    return false;
                },

                _computeOrgFormReady: function(orgName, orgAlertEmails, orgAvatar, loading, org){
                    if (orgName && orgName.trim() != "" && org.is_owner && !loading &&
                        (orgName != org.name || (orgAlertEmails && orgAlertEmails != org.alerts_email.join('\n')) ||
                         (orgAvatar && orgAvatar != org.avatar)))
                        return true;
                    return false;
                },

                _computeShowProgress: function(sendingData) {
                    return sendingData;
                },

                _computeAvatarURL: function(orgAvatar) {
                    if (orgAvatar.length)
                        return '/api/v1/avatars/' + orgAvatar;
                },

                _submitUserForm: function(e, user) {
                    var payload = {
                        action: 'update_details',
                        first_name: this.firstName,
                        last_name: this.lastName
                    };

                    this.$.userAjaxRequest.headers["Content-Type"] = 'application/json';
                    this.$.userAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                    this.$.userAjaxRequest.body = payload;
                    this.$.userAjaxRequest.generateRequest();
                    console.log('loadingUser', this.loadingUser);
                },

                _submitOrgForm: function(e, org) {
                    var payload = {
                        new_name: this.orgName,
                        alerts_email: this.orgAlertEmails
                    };

                    if (this.orgAvatar)
                        payload['avatar'] = this.orgAvatar;

                    this.$.orgAjaxRequest.headers["Content-Type"] = 'application/json';
                    this.$.orgAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                    this.$.orgAjaxRequest.body = payload;
                    this.$.orgAjaxRequest.generateRequest();
                    console.log('loadingOrg', this.loadingOrg);
                },

                _handleAjaxResponse: function(e) {
                    this.fire('toast',{msg:"Changes saved succesfully!",duration:3000});
                },

                _handleAjaxError: function() {
                    this.set('userError', true);
                    this.$.usererrormsg.textContent = e.detail.request.xhr.responseText;
                },
                _handleOrgAjaxError: function(e) {
                    this.set('orgError', true);
                    this.$.orgerrormsg.textContent = e.detail.request.xhr.responseText;
                },
                handleIpResponse: function() {
                    this.fire('toast',{msg:"IPs saved succesfully!",duration:3000});
                },
                handleIpError: function(e) {
                    this.set('ipError', true);
                    this.$.iperrormsg.textContent = e.detail.request.xhr.responseText;
                },
            });
        })();
    </script>
</dom-module>
