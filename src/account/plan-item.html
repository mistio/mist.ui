<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="../helpers/dialog-element.html">

<dom-module id="plan-item">
    <template>
        <style include="shared-styles">
        :host {
            display: block;
            margin: 8px;
            box-sizing: border-box;
        }
        /*
        :host[is-current] {
            color: #ffffff;
            background-color: #039BE5;
        }*/

        hr {
            border: none;
            border-bottom: 1px solid rgba(0,0,0,0.13);
        }

        #select {
            color: #ffffff;
            background-color: #039BE5;
        }
        .text-center {
            text-align: center;
        }
        #cancelButton, #updatePaymentMethodButton {
            font-size: 0.8em;
            margin-top: 16px;
        }
        paper-spinner-lite.white {
            --paper-spinner-color: #fff;
        }
        .title {
            color: #fff;
            text-transform: uppercase;
            padding: 20px 0;
            font-size: 18px;
        }
        .current {
            background-color: #2196F3;
        }
        .bg-0 {
            background-color: #999;
        }
        
        .bg-1 {
            background-color: #777;
        }
        
        .bg-2 {
            background-color: #555;
        }
        
        .bg-3 {
            background-color: #222;
        }
        .plan {
            background-color: #fff;
            margin-bottom: 50px;
            overflow: auto;
        }

        .plan, .plan > * {
            box-sizing: border-box;
            margin: 0;
        }

        .plan paper-button {
            margin: 0 !important;
            font-size: 14px;
            height: 2rem;
            width: auto;
        }
        
        .plan-body-item {
            padding: 30px 10px 50px 10px;
        }
        
        @media only screen and (max-width: 600px) {
            .plan-body-item {
                min-height: 50px;
            }
        }
        
        .plan-body-item + .plan-body-item {
            border-top: 1px solid #d4d4d4;
        }
        
        .plan-body-item:last-child {
            border-bottom: 1px solid #d4d4d4;
        }
        
        .plan-body-item.highlight {
            background-color: #f2f2f2;
        }
        
        .plan-body-item * {
            width: 100%;
        }

        .plan-body-item:not(:first-child) {
            padding: 0 10px;
        }

        .plan-body-item:last-child p {
            font-weight: bold;
        }
        
        .valign {
            display: block;
        }
        
        .price {
            font-weight: 700;
            line-height: 1;
            padding: 0;
            margin: 8px;
            font-size: 3.56rem;
        }
        
        .price sub,
        .price sup {
            font-size: 18px;
            font-weight: 300;
            vertical-align: middle;
        }
        
        .price sup {
            font-size: 24px;
            padding: 0 5px;
            vertical-align: top;
        }

        .price sub {
            vertical-align: baseline;
        }

        .selected {
            background-color: var(--green-color);
            color: #fff;
            font-weight: 500;
            text-transform: uppercase;
            padding: 0.4em 0.57em;
            border-radius: 3px;
            font-size: 14px;
            max-width: 100px;
            margin: 0 auto;
            margin-bottom: 16px;
        }
        .selected iron-icon {
            color: inherit;
            display: inline-block;
            width: 24px;
            height: 24px;
        }
        .cancel {
            padding: 16px;
            cursor: pointer;
        }
        
        </style>
        <div class="plan text-center">
            <div class$="title [[class]]">
                [[plan.title]]
            </div>
            <div class="plan-body">
                <div class="plan-body-item">
                    <div class="valign">
                        <h2 class="price"><sup>$</sup>[[plan.price]]<sub>/mo.</sub></h2>
                        <paper-button class="blue" raised on-tap="_selectPlan" hidden$="[[isCurrent]]">Purchase</paper-button>
                        <div class="selected" hidden$="[[!isCurrent]]"><iron-icon icon="icons:check"></iron-icon> selected</div>
                        <a class="cancel regular blue-link" on-tap="_cancelPlan" hidden$="[[!isCurrent]]">Cancel plan</a>
                    </div>
                </div>
                <div class="plan-body-item">
                    <p class="valign">[[plan.vcpu_limit]] vCPUs</p>
                </div>
                <div class="plan-body-item">
                    <p class="valign">[[plan.datapoint_limit]] datapoints/day</p>
                </div>
                <div class="plan-body-item">
                    <p class="valign">[[plan.checks_limit]] rule checks/day</p>
                </div>
                <div class="plan-body-item">
                    <p class="valign">[[plan.retention]] retention</p>
                </div>
            </div>
        </div>

        <dialog-element id="plancancel"></dialog-element>
        <iron-ajax id="cancelPlanAjaxRequest"
                        url="/api/v1/org/[[org.id]]/billing"
                        method="DELETE"
                        loading="{{loadingCancel}}"
                        on-response="_handleCancelAjaxResponse"
                        on-error="_handleCancelAjaxError"
                        handle-as="xml"></iron-ajax>

    </template>
    <script>
            Polymer({
                is: 'plan-item',

                properties: {
                    plan: {
                        type: Object
                    },
                    org: {
                        type: Object
                    },
                    index: {
                        type: Number,
                        value: 0
                    },
                    isFreePlan: {
                        type: Boolean,
                        computed: "_computeIsFreePlan(plan.title)"
                    },
                    isCurrent: {
                        type: Boolean,
                        computed: '_computeIsCurrent(plan,org)',
                        reflectToAttribute: true
                    },
                    priceText: {
                        type: String,
                        computed: '_computePriceText(plan.price)'
                    },
                    descriptionText: {
                        type: String,
                        computed: '_computeDescriptionText(plan)'
                    },
                    discountedPriceText: {
                        type: String,
                        computed: '_computeDiscountedPriceText(plan.promo)'
                    },
                    enterprise: {
                        type: Boolean,
                        computed: "_computeIsEnteriprise(plan.title, org)",
                        value: false
                    },
                    buttonText: {
                        type: String,
                        computed: '_computeButtonText(plan, org.current_plan)'
                    },
                    loadingCancel: {
                        type: Boolean,
                        value: false
                    },
                    class: {
                        type: String,
                        computed: '_computeClass(plan, org.current_plan)'
                    }
                },
                listeners: {
                    'confirmation': '_cancelPlanConfirmed',
                },
                _computeClass: function(plan, current) {
                    if (plan.title == this.org.current_plan.title)
                        return "current";
                    else if (plan.title == "Small")
                        return "bg-1";
                    else if (plan.title == "Medium")
                        return "bg-2";
                    else if (plan.title == "Large")
                        return "bg-3";
                },
                _computePriceText: function(price) {
                    return price != null ? '$' + price + '/mo' : '';
                },
                _computeIsCurrent: function(plan,org){
                    return plan.title == "Small"; //this.org.current_plan.title;
                },
                _computeIsFreePlan: function(planTitle){
                    return planTitle == "Free";
                },
                _computeDescriptionText: function(plan) {
                    console.log('_computeDescriptionText', plan.description, plan)
                    var monitoringFor = '';
                    if (this.plan.monitor_limit) {
                        monitoringFor = " and monitoring for "+ this.plan.monitor_limit +" of them";
                    }
                    return !this.plan.description || this.plan.description == "" ? 'up to ' + this.plan.machine_limit + '  machines'+monitoringFor : this.plan.description;
                },
                _computeDiscountedPriceText: function(promo) {
                    if (promo) {
                        var newPrice = Math.round(price * (1 - (promo.discount / 100)));
                        return '$' + newPrice + '/mo';
                    }
                    return '';
                },
                _computeReadableDate: function(date) {
                    return date ? moment.utc(date * 1000).format("MMMM Do YYYY") : date;
                },
                _selectPlan: function(e) {
                    this.fire('plan-selected', {plan: this.plan});
                },
                _triggerInfo: function() {
                    console.log('info popup');
                },
                _computeIsEnteriprise: function(title, org){
                    return this.plan.title && this.plan.title == "Enterprise" && !this.org.enterprise_plan.title;
                },
                _cancelPlan: function(){
                    this._showDialog({
                        title: 'Cancel current plan',
                        body: "Canceling your plan will significantly lower your account's limits. After cancelation your plan will expire at the end of your monthly subscription." ,
                        danger: true,
                        reason: "plan.cancel",
                        action: "Cancel Your plan",
                        undo: "not yet"
                    });
                },
                _showDialog: function(info) {
                    var dialog = this.querySelector('dialog-element');
                    for (var i in info) {
                        dialog[i] = info[i];
                    }
                    dialog._openDialog();
                },
                _cancelPlanConfirmed: function(e){
                    console.log('_cancelPlanConfirmed', e);
                    var reason = e.detail.reason,
                        response = e.detail.response;

                    if (response.confirmed && reason == "plan.cancel") {
                        this.$.cancelPlanAjaxRequest.headers["Content-Type"] = 'application/json';
                        this.$.cancelPlanAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                        this.$.cancelPlanAjaxRequest.generateRequest();
                    }
                },
                _handleCancelAjaxResponse: function(e){
                    this.fire('toast',{msg:'You cancelled your plan. ',duration:3000});
                },

                _handleCancelAjaxError: function(e){
                    this.fire('error-on-cancel-plan',{error: e.detail.request.xhr.responseText});
                },
                _computeButtonText: function(plan, org){
                    if (this.plan.title && this.org.current_plan.machine_limit > plan.machine_limit){
                        console.log('UP / DOWN', this.org.current_plan.machine_limit, plan.machine_limit)
                        return 'Downgrade';
                    }
                    else if (!this.org.current_plan.machine_limit || this.org.current_plan.machine_limit < plan.machine_limit){
                        return 'Upgrade';
                    }
                    else {
                        return "Purchase";
                    }
                },
                showCancel: function(plan, org){
                    return this.plan.title && this.org.current_plan.title == plan.title && !this.org.current_plan.expiration;
                },
                showPurchase: function(planexpiration, isCurrent) {
                    return (!this.isCurrent && this.plan.price != null) || (this.isCurrent && this.org.current_plan.expiration); 
                }
            });
    </script>
</dom-module>
