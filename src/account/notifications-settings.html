<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">

<dom-module id="notifications-settings">
    <template>
        <style is="custom-style" include="lists shared-styles forms">
            :host {
                display: block;
            }

            :host paper-material {
                display: block;
                padding: 0;
            }

            .info-head {
                padding: 8px 16px;
                background: #eee;
                border-bottom: 2px solid #ddd;
            }

            paper-item.row {
                width: 100%;
            }

            .flex-horizontal-with-ratios {
                @apply(--layout-horizontal);
            }

            .flexchild {
                @apply(--layout-flex);
            }

            label {
                color: rgba(0, 0, 0, 0.54) !important;
                font-size: 12px;
            }

            .grid-row {
                box-sizing: border-box;
                margin-right: 0;
                margin-left: 0;
            }

            .row {
                margin-top: 6px;
                margin-bottom: 6px;
                width: 100%;
            }

            .head {
                margin-bottom: 16px;
            }

            h2.title {
                font-weight: 500;
            }

            h2.title, h2.title~p {
                margin-top: 0;
                margin-bottom: 0;
            }

            paper-radio-button {
                --paper-radio-button-checked-color: var(--paper-light-blue-500);
                --paper-radio-button-checked-ink-color: var(--paper-light-blue-500);
                --paper-radio-button-unchecked-ink-color: var(--paper-light-blue-900);
            }
            hr {
                width: 100%;
            }
            :host paper-progress{
                position: absolute;
                width: 100%;
                left: 0;
                right: 0;
            }
            
            .margin {
                margin: 32px 0;
            }

            .bottom-actions {
                padding-bottom: 24px;
                padding-left: 1rem;
            }

            .progress {
                margin: 32px 0 8px 0;
                width: 100%;
            }
            paper-progress.progresserror ::content #primaryProgress {
                background-color: var(--red-color);
            }
            .errormsg-container {
                color: var(--red-color);
                padding-left: 24px;
                padding-right: 24px
            }
            .errormsg-container iron-icon {
                color: inherit;
            }

            paper-icon-button.white {
                --paper-icon-button-ink-color: var(--paper-orange-500);
            }

            paper-icon-button.delete-avatar-icon {
                top: -12px;
            }

            iron-image.avatar-preview {
                width: 80px;
                height: 36px;
                margin: 2px 6px;
            }

            div.existing-org-logo {
                display: inline-block;
                vertical-align: middle;
                text-align: center;
            }

            div.org-logo-container {
                background-color: #2F2F3E;
                margin: 6px;
                display: inline-block
            }

            div.org-logo-field-title {
                color: var(--paper-light-blue-600);
                text-transform: uppercase;
                font-weight: 400;
                font-size: 12px;
                margin-left: -17px;
            }

            .overrideLabel {
                display: inline-flex;
                width: 60%;
                vertical-align: top;
            }

            paper-toggle-button {
                margin: auto;
                display: inline-flex;
                cursor: pointer;
                /*--paper-toggle-button-checked-bar-color: #2196F3;
                --paper-toggle-button-checked-button-color: #fff;*/
            }

            paper-button.red {
                --paper-button-checked-bar-color: #d96557;
                --paper-toggle-button-checked-button-color: #fff;
            }

            .head {
                padding: 24px 24px 0 24px;
            }

            .summary {
                padding: 0 24px 0 24px;
            }

            .text-right {
                text-align: right;
            }
        </style>

        <paper-card>
            <div class="grid-row">
                <div class="xs12 head">
                    <h2 class="title">Notification Overrides</h2>
                </div>
                <div class="summary xs12 m12 l12">
                    <p>Notification overrides allow you to personalize delivery of notifications and recommendations about your infrastructure.</p>
                </div>
            </div>
            <div class="card-content">
                <div class="info-list">
                    <div class="info-head flex-horizontal-with-ratios">
                        <div class="flexchild">Notification Type</div>
                        <div class="flexchild text-right">Delivery</div>
                        <div class="flexchild text-right">&nbsp;</div>
                    </div>
                    <div class="info-body flex-horizontal-with-ratios">
                        <template is="dom-repeat" items="[[notificationOverrides]]" as="override">
                            <paper-item class="row flex-horizontal-with-ratios plan-record">
                                <div class="flexchild plan-date">
                                    <span class="name">[[_computeOverrideLabel(override, machines)]]</span>
                                </div>
                                <div class="flexchild plan-action text-right">
                                    <paper-toggle-button checked="{{_computeAllowed(override)}}" on-change="_overrideChanged" index="[[index]]">[[_computeOverrideStateLabel(override, machines)]]</paper-toggle-button>
                                </div> 
                                <div class="flexchild plan-title text-right">
                                    <paper-button class="red" on-tap="_deleteOverrideTapped">Delete</paper-button>
                                </div>   
                            </paper-item>                        
                        </template>
                    </div>
                </div>
            </div>
            <div id="error" class="error" hidden$="[[!hasError]]"></div>
            <div class="bottom-actions clearfix xs12">
                <paper-button class="pull-right" 
                    disabled$="[[!formReady]]" 
                    raised on-tap="_submitForm">Save Notification Overrides</paper-button>
            </div>
        </paper-card>

        <iron-ajax auto id="getNotificationOverridesRequest" 
            method="GET" 
            url="/api/v1/notification_overrides" 
            on-response="_handleGetOverridesResponse" 
            on-error="_handleGetOverridesError" 
            handle-as="json"></iron-ajax>

       <iron-ajax id="setNotificationOverridesRequest"
            url="/api/v1/notification_overrides"
            method="PUT"
            on-response="_handleSetOverridesResponse"
            on-error="_handleSetOverridesError"
            handle-as="json"></iron-ajax>

        <iron-ajax id="deleteNotificationOverrideRequest"
            url="/api/v1/notification_overrides"
            method="DELETE"
            on-response="_handleDeleteOverrideResponse"
            on-error="_handleDeleteOverrideError"
            handle-as="json"></iron-ajax>

    </template>
    <script>
        Polymer({
            is: 'notifications-settings',
            properties: {
                machines: Object,
                notificationOverrides: Array,
                overridesError: Boolean
            },

            _computeAllowed: function(override) {
                return override.value == "ALLOW";
            },

            _computeOverrideLabel: function(override, machines) {
                var lowerCase = (override.channel + " " + override.source).toLowerCase();
                if (lowerCase.includes("inapp")) 
                {
                    if (lowerCase.includes("recommendation"))
                    {
                        if (override.machine)
                        {
                            var machineName;
                            if (machines && machines[override.machine._ref.$id])
                            {
                                machineName = machines[override.machine._ref.$id].name;
                            }
                            else
                            {
                                machineName = override.machine._ref.$id;
                            }
                            return "Recommendations for machine " + machineName;
                        }
                        else if (override.cloud)
                        {
                            return "Recommendations for cloud " + override.cloud._ref.$id;
                        }
                        else if (override.tag)
                        {
                            return "Recommendations for tag " + override.tag._ref.$id;
                        }
                        else
                        {
                            return "In-App Recommendations";
                        }
                    }
                    else
                    {
                        if (override.machine)
                        {
                            if (machines && machines[override.machine._ref.$id])
                            {
                                machineName = machines[override.machine._ref.$id].name;
                            }
                            else
                            {
                                machineName = override.machine._ref.$id;
                            }
                            return "Notifications for machine " + machineName;
                        }
                        else if (override.cloud)
                        {
                            return "Notifications for cloud " + override.machine._ref.$id;
                        }
                        else if (override.machine)
                        {
                            return "Notifications for tag " + override.tag._ref.$id;
                        }
                        else
                        {
                            return "In-App Notifications";
                        }
                    }
                }
                else if (lowerCase.includes("email"))
                {
                    return "Email Reports";
                }
            },

            _computeOverrideStateLabel: function(override, machines) {
                var valueString = override.value.toLowerCase();
                return valueString.charAt(0).toUpperCase() + valueString.slice(1);
            },

            _overrideChanged: function(e) {
                var checked = e.target.checked;
                var index = e.target.index;
                var newOverride = JSON.parse(JSON.stringify(this.notificationOverrides[index]));
                newOverride.value = checked ? "ALLOW" : "BLOCK";
                this.splice('notificationOverrides', index, 1, newOverride);
            },

            _getOverrides: function(e, user) {
                this.$.getNotificationOverridesRequest.headers["Content-Type"] = 'application/json';
                this.$.getNotificationOverridesRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                this.$.getNotificationOverridesRequest.generateRequest();
            },

            _handleGetOverridesResponse: function(e) {
                this.set('notificationOverrides', JSON.parse(e.detail.response));
            },

            _handleGetOverridesError: function() {
                this.set('overridesError', true);
            },

            _deleteOverrideTapped: function(e) {
                var index = e.target.index;
                var payload = {
                    action: 'delete_notification_override',
                    override_id: this.overrides[index].id
                };
                this.$.setNotificationOverridesRequest.headers["Content-Type"] = 'application/json';
                this.$.setNotificationOverridesRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                this.$.setNotificationOverridesRequest.body = payload;
                this.$.setNotificationOverridesRequest.generateRequest();
            },

            _handleDeleteOverrideResponse: function(e) {
                this.fire('toast',{msg:"Notification override deleted succesfully!",duration:3000});
            },

            _handleDeleteOverrideError: function() {
                this.set('overridesError', true);
                this.$.usererrormsg.textContent = e.detail.request.xhr.responseText;
            },

            _submitForm: function(e) {
                var payload = {
                    action: 'update_notification_overrides',
                    overrides: this.notificationOverrides
                };
                this.$.setNotificationOverridesRequest.headers["Content-Type"] = 'application/json';
                this.$.setNotificationOverridesRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                this.$.setNotificationOverridesRequest.body = payload;
                this.$.setNotificationOverridesRequest.generateRequest();
            },

            _handleSetOverridesResponse: function(e) {
                this.fire('toast',{msg:"Changes saved succesfully!",duration:3000});
            },

            _handleSetOverridesError: function() {
                this.set('overridesError', true);
                this.$.usererrormsg.textContent = e.detail.request.xhr.responseText;
            }
        });
    </script>
</dom-module>
