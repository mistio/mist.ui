<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/mist-list/mist-list.html">

<link rel="import" href="../helpers/dialog-element.html">
<link rel="import" href="../helpers/mist-loading-behavior.html">
<link rel="import" href="../element-for-in/element-for-in.html">
<link rel="import" href="../mist-rules/mist-rules.html">
<link rel="import" href="../mist-monitoring.html">
<link rel="import" href="../mist-actions.html">

<link rel="import" href="machine-actions.html">
<link rel="import" href="machine-r12ns.html">

<dom-module id="machine-page">
    <template>
        <style include="shared-styles tags-and-labels info-table-style single-page">
            :host {
                display: block;
            }
            a:hover {
                cursor:pointer;
            }
            .columns {
                @apply(--layout-horizontal);
                flex: 1 100%;
                margin-bottom: 16px;
            }
            .columns paper-material > .break {
                word-break: break-all;
            }
            .left {
                line-height: 1.6em;
            }
            .left, .right {
                @apply(--layout-vertical);
                align-items: flex-start;
                flex-direction: column;
                flex: 1 100%;
            }
            .left h3, .right h3 {
                margin-bottom: 0;
            }
            .flex-horizontal-with-ratios {
                @apply(--layout-horizontal);
                align-content: stretch;
                flex: 100%;
            }

            .flexchild {
                @apply(--layout-flex);
            }

            .paper-header h2 {
                @apply(--layout-flex-none);
            }

            .machine-ip {
                margin: 0;
            }

            paper-material {
                padding: 24px;
                box-sizing: border-box;
                width: 100%;
            }
            paper-material.info-card {
                padding: 0;
            }
            paper-material > h2 {
                line-height: initial !important;
                margin-bottom: 0;
                cursor: pointer;
            }

            .subhead {
                box-sizing: border-box;
                position: absolute;
                width: 100%;
                left: 0;
                height: 57px;
                bottom: -57px;
                right: 0;
                z-index: 9;
                color: rgba(0, 0, 0, 0.87);
            }

            paper-header-panel::content #dropShadow {
                top: 56px;
            }

            paper-toolbar::content #bottomBar .right-actions {
                transition: var(--paper-toolbar-transition, margin-right 0.18s ease-in);
            }

            paper-toolbar:not(.tall)::content #bottomBar .right-actions {
                margin-right: 70px;
            }

            .label {
                padding: 2px !important;
            }

            #machine_actions paper-button {
                text-align: left !important;
            }
            .machine-state-icon {
                background-color: #fff !important;
            }
            .machine-state-icon.running {
                color: var(--green-color) !important;
            }

            .machine-state-icon.terminated {
                color: var(--mist-dark-color) !important;
            }

            .machine-state-icon.stopped {
                color: var(--orange-color) !important;
            }

            .machine-state-icon.error, .packetloss {
                color: var(--red-color) !important;
            }

            .machine-state-icon.unknown, .machine-state-icon.pending {
                color: #ccc !important;
            }

            paper-material .smallcaps {
                margin-top: 0;
            }
            .cost,
            paper-material .tags-head {
                margin-bottom: 16px;
            }
            :host .tag {
                display: inline !important;
                padding: 4px;
                margin-right: 4px;
            }
            polyana-dashboard ::content h3 {
                text-transform: uppercase;
                font-size: 16px;
                font-weight: 500;
                line-height: 36px;
            }
            polyana-dashboard {
              display: block;
                height: auto;
                overflow: hidden;
            }
            paper-button[disabled] {
                opacity: 0.54
            }
            paper-button.left-icon iron-icon {
                margin: 0 4px 0 0;
            }
            paper-button.right-icon iron-icon {
                margin: 0 0 0 4px;
            }
            .machine-key {
                line-height: 24px;
                display: inline-block;
                vertical-align: top;
            }
            .machine-key iron-icon {
                margin-right: 8px;
                opacity: 0.32;
                cursor: pointer;
            }
            .machine-key iron-icon.delete {
                opacity: 0.13;
                margin-right: 16px;
                height: 12px;
                width: 12px;
                transition: opacity 100 ease-in;
            }
            .machine-key:hover iron-icon.delete {
                opacity: 0.32;
            }
            #pendingKeyrequest paper-spinner {
                width: 24px !important;
                height: 24px !important;
                vertical-align: middle !important;
            }
            machine-actions {
                display: flex;
                font-size: 1em;
            }
            machine-actions ::content .actions {
                height: auto;
                display: flex;
                vertical-align: auto;
                padding: 0;
            }
            machine-actions ::content .item-actions {
                margin-left: 0 !important;
            }
            :host machine-actions ::content mist-actions ::content paper-button:not(.more).actions,
            :host machine-actions ::content mist-actions ::content paper-button.dropdown-trigger {
                padding: 16px !important;
                margin: 0 !important;
            }
            span[class*="dc-"] {
                padding-top: 16px;
                display: none;
            }
            .dc-true {
                display: inline-block;
                color: #F57F17;
            }
            .dc-true iron-icon {
                display: inline-block;
                color: inherit;
            }
            .dc-false {
                display: inline-block;
                color: var(--green-color);
                font-size: 0.9em;
                font-weight: 500;
            }
            .probe-df {
                height: 240px;
                overflow-y: scroll;
            }
            .probe-data {
                position: relative;
            }
            .probe-data.hasprobe {
                overflow: visible;
            }
            .probe-data.hasprobe {
                height: 8px;
                width: 4px;
                display: inline-block;
                margin: 2px 8px;
            }
            /* midterm */
            .midlow {
                background: #42A5F5; /*cyan*/
            }
            .midmedium {
                background: #FFCA28; /*orange*/
            }
            .midhigh {
                background: #EF5350; /*red*/
            }
            .mideco {
                background: #69b46c; /*green*/
            }
            /* shortlow + long */
            .shortlow.longlow {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #42A5F5, -1px 0 0 #fff, -4px 0 0 #42A5F5; /*cyan cyan*/
            }
            .shortlow.longmedium {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #42A5F5, -1px 0 0 #fff, -4px 0 0 #FFCA28; /*cyan orange*/
            }
            .shortlow.longhigh {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #42A5F5, -1px 0 0 #fff, -4px 0 0 #EF5350; /*cyan red*/
            }
            .shortlow.longeco {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #42A5F5, -1px 0 0 #fff, -4px 0 0 #69b46c; /*cyan green*/
            }
            /* shortmedium + long */
            .shortmedium.longlow {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #FFCA28, -1px 0 0 #fff, -4px 0 0 #42A5F5; /*orange cyan*/
            }
            .shortmedium.longmedium {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #FFCA28, -1px 0 0 #fff, -4px 0 0 #FFCA28; /*orange orange*/
            }
            .shortmedium.longhigh {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #FFCA28, -1px 0 0 #fff, -4px 0 0 #EF5350; /*orange red*/
            }
            .shortmedium.longeco {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #FFCA28, -1px 0 0 #fff, -4px 0 0 #69b46c; /*cyan green*/
            }
            /* shorthigh + long */
            .shorthigh.longlow {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #EF5350, -1px 0 0 #fff, -4px 0 0 #42A5F5; /*red cyan*/
            }
            .shorthigh.longmedium {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #EF5350, -1px 0 0 #fff, -4px 0 0 #FFCA28; /*red orange*/
            }
            .shorthigh.longhigh {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #EF5350, -1px 0 0 #fff, -4px 0 0 #EF5350; /*red red*/
            }
            .shorthigh.longeco {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #EF5350, -1px 0 0 #fff, -4px 0 0 #69b46c; /*red green*/
            }
            /* shorteco + long */
            .shorteco.longlow {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #69b46c, -1px 0 0 #fff, -4px 0 0 #42A5F5; /*green cyan*/
            }
            .shorteco.longmedium {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #69b46c, -1px 0 0 #fff, -4px 0 0 #FFCA28; /*green orange*/
            }
            .shorteco.longhigh {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #69b46c, -1px 0 0 #fff, -4px 0 0 #EF5350; /*green red*/
            }
            .shorteco.longeco {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #69b46c, -1px 0 0 #fff, -4px 0 0 #69b46c; /*green green*/
            }

            @media (max-width: 1024px) {
                .machine-key {
                    display: block;
                }
                .tag {
                    display: inline-block !important;
                }
            }
            .m-info-head {
                text-transform: uppercase;
                font-weight: bold;
                font-size: 0.8em;
                display: inline-block;
                width: 80px;
                opacity: 0.54;
            }
            #rightcolumn .m-info-head {
                width: 100%;
            }
            .probe-button > * {
                vertical-align: middle;
            }
            #probeButton {
                background-color: transparent;
                font-weight: 400;
                font-size: 0.9em;
                color: #2196F3;
                display: inline-block;
                padding: 0;
            }
            #probeSpinner {
                display: inline-block;
                padding: 8px;
            }
            @media screen and (max-width: 720px) {
                table.info-table {
                    table-layout: fixed;
                }
                table.info-table tr.change-dir > td.change-dir {
                    width: 200%;
                    box-sizing: border-box;
                    display: block;
                    overflow: scroll;
                    display: block;
                }
            }
            @media screen and (max-width: 450px) {
                paper-menu-button[vertical-align="top"] ::content .dropdown-content.paper-menu-button {
                    max-height: 200px !important;
                }
            }
            iron-icon.icon {
                margin-right: 4px;
            }

            paper-material.machine-logs {
                padding: 0;
                overflow: visible;
            }
            mist-list {
                position: relative;
                width: 100%;
                padding: 0;
                margin: 0;
                height: 600px;
                font-size: 75%;
                --row-height: 48px;
            }
            .smaller {
                font-size: 0.8em;
                /*font-family: monospace;*/
            }
        </style>

        <div id="content">
            <!-- <div class="is-loading" hidden$="[[!isLoading]]">
                <paper-spinner active hidden$="[[!isLoading]]"></paper-spinner>
            </div> -->
            <machine-actions id="actions_machine" items="[[itemArray]]" model="[[model]]" actions="{{actions}}"></machine-actions>
            <paper-material class="single-head layout horizontal" style$="color:#fff;background-color: [[section.color]];">
                <span class="icon">
                    <iron-icon class$=" machine-state-icon [[machineState]]" icon="[[section.icon]]"></iron-icon>
                </span>
                <div class="title flex">
                    <h2>
                        [[machineName]]
                    </h2>
                    <div class="subtitle">
                        [[machineState]] <span class="desc" hidden$="[[_hasExtraStatus(machine)]]">[[_computeExtraStatus(machine, machine.*, model.machines.*)]]</span>
                    </div>
                </div>
                <template is="dom-if" if="[[itemArray]]" restamp>
                    <mist-actions id="actions_machine" items="[[itemArray]]" model="[[model]]" actions="{{actions}}" use-half-width></mists-actions>
                </template>
            </paper-material>
            <paper-material hidden$="[[!isMissing]]">
                <div class="missing">Machine not found.</div>
            </paper-material>
            <div class="columns">
                <paper-material id="leftcolumn resource-description" class="left">
                    <span hidden$="[[!machine.cloud.title]]"><span class="m-info-head">Cloud:</span>
                        <iron-icon class="cloud icon" src$="[[_computeCloudIcon(machine.cloud.provider)]]"></iron-icon>
                        [[machine.cloud.title]]</span>
                    <span hidden$="[[!_existsImage(machine.extra)]]" class="break"><span class="m-info-head">Image:</span>
                        <iron-icon class="image icon" src$="[[_computeImageIcon(machine)]]" hidden$="[[!_computeImageIcon(machine)]]"></iron-icon>
                        [[_computeMachineImage(machine)]]</span>
                    <span hidden$="[[!machineSize]]" class="break"><span class="m-info-head">Size:</span>
                        [[machineSize]]</span>
                    <span hidden$="[[!machine.created]]"><span class="m-info-head">Created:</span>
                        [[_fromNow(machine.created)]]</span>
                    <hr/>
                    <div hidden$="[[!machine.probe.ssh.updated_at]]">
                        <span class="m-info-head" hidden$="[[!machine.probe.ssh.loadavg]]">Load:</span>
                        <span class$="probe-data [[itemProbeClasses(machine)]]"> </span>
                        <span class="smaller" hidden$="[[!machine.probe.ssh.loadavg]]"> [[_listToString(machine.probe.ssh.loadavg)]] - [[machine.probe.ssh.cores]] vcpu cores</span> <br/>
                    </div>
                    <div hidden$="[[!machine.probe.ping.updated_at]]">
                        <span class="m-info-head">RTT:</span>
                        <span class="smaller">min/avg/max/std = [[machine.probe.ping.rtt_min]]/[[machine.probe.ping.rtt_avg]]/[[machine.probe.ping.rtt_max]]/[[machine.probe.ping.rtt_std]] ms</span>
                        <span class="smaller packetloss" hidden$=[[!machine.probe.ping.packets_loss]]>-- [[_computePacketLossPercent(machine.probe.ping.packets_loss)]]% packet loss --</span>
                    </div>
                    <div class="probe-button">
                        <span class="m-info-head">Probed:</span> 
                        <span class="smaller"> [[_computeProbeString(machine.probe.ssh.updated_at, machine.probe.ping.updated_at)]]</span>
                        <br /><paper-button id="probeButton" class="blue-link" on-tap="_probeMachine" disabled="{{probeLoading}}" hidden$="[[!machine.key_associations.length]]">probe now</paper-button>
                        <paper-spinner id="probeSpinner" active="{{probeLoading}}"></paper-spinner>
                    </div>
                    <div hidden$="[[!kernelInfo]]">
                        [[kernelInfo]]
                    </div>
                    <div hidden$="[[!machine.probe]]">
                        <span class$="dc-[[machine.probe.ssh.dirty_cow]]" hidden$="[[machine.probe.ssh.dirty_cow]]">
                            Dirty COW check passed.
                        </span>
                        <span class$="dc-[[machine.probe.ssh.dirty_cow]]" hidden$="[[!machine.probe.ssh.dirty_cow]]">
                            <iron-icon hidden$="[[!machine.probe.ssh.dirty_cow]]" icon="icons:report-problem" on-tap="_showRecommendationDialog"></iron-icon> [[dirtyCowAlert]]
                            <a class="regular blue-link" on-tap="_showRecommendationDialog">Show recommendation.</a>
                        </span>
                    </div>
                </paper-material>
                <paper-material id="rightcolumn" class="right">
                    <div hidden$="[[!machine.cost.monthly]]">
                        <div class="m-info-head">Monthly Cost:</div>
                        <div class="cost">
                            $[[_toFixed(machine.cost.monthly)]]
                        </div>
                    </div>
                    <div hidden$="[[!machineKeys.length]]">
                        <div class="m-info-head">Associated Keys:</div>
                        <div class="associatedKeys">
                            <template is="dom-repeat" items="{{machineKeys}}" as="key" id="machineKeysDomRepeat">
                                <div class="machine-key" hidden$="[[!_visibleKey(model,key)]]">
                                    <a class="regular blue-link flexchild" href$="/keys/[[key.keypair]]"><iron-icon icon="communication:vpn-key"></iron-icon> [[_computeKeyName(key.keypair)]]</a>
                                    <iron-icon data-keyid="[[key.keypair]]" data-keyname="[[_computeKeyName(key.keypair)]]" icon="icons:cancel" on-tap="disassociateKey" class="delete"></iron-icon>
                                </div>
                            </template>
                            <div class="machine-key" id="pendingKeyRequest">
                                <paper-spinner active hidden$="[[!isPendingKeyRequest]]"></paper-spinner>
                            </div>
                        </div>
                    </div>
                    <div hidden$="[[!machine.tags.length]]">
                        <h3 class="m-info-head">TAGS:</h3>
                        <template is="dom-repeat" items="[[machine.tags]]">
                            <span class="tag">[[item.key]]<span hidden$="[[!item.value]]">=</span>[[item.value]]</span>
                        </template>
                    </div>
                </paper-material>
            </div>

            <paper-material id="r12nsBlock" class="info-card" hidden$=[[!r12ns.length]]>
                <machine-r12ns r12ns=[[r12ns]] can-resize=[[machine.actions.resize]]></machine-r12ns>
            </paper-material>

            <template is="dom-if" if=[[monitoring]]>
            <paper-material id="monitoringBlock" class="info-card">
                <mist-monitoring
                    id="mistMonitoring"
                    resource="[[machine]]"
                    state="[[machineState]]"
                    monitoring="[[model.monitoring]]"
                    section="[[section]]"
                    datasources="[[datasources]]"
                    hidden$="[[hidden]]"
                    machine-keys="[[machineKeys]]"
                    incidents="[[_filterMachinesIncidents(model.incidentsArray)]]"></mist-monitoring>
                <mist-rules
                    id="monitoringRules"
                    machine="[[machine.machine_id]]"
                    cloud="[[machine.cloud.id]]"
                    builtin-metrics="[[model.monitoring.builtin_metrics]]"
                    custom-metrics="[[model.monitoring.custom_metrics]]"
                    incidents="[[model.incidentsArray]]"
                    rules="[[model.monitoring.rules]]"
                    resource="[[machine]]"
                    user-email="[[model.user.email]]"
                    hidden$="[[!isActivated]]"></mist-rules>
            </paper-material>
            </template>
            <paper-material class="info-card">
                <h2 style$="color:#fff;background-color: [[section.color]];">Basic Info</h2>
                <div class="card-content">
                    <table class="info-table">
                        <template is="dom-if" if="[[machine.public_ips]]">
                            <tr>
                                <td>Machine ID (Mist.io unique id)</td>
                                <td>[[machine.id]]</td>
                            </tr>
                            <tr>
                                <td>Machine ID given by the provider</td>
                                <td>[[machine.machine_id]]</td>
                            </tr>
                            <tr><td>Public IPs</td>
                                <td>[[displayArray(machine.public_ips)]]</td>
                            </tr>
                            <tr>
                                <td>Private IPs</td>
                                <td><template is="dom-repeat" items="[[machine.private_ips]]">
                                        [[item]]
                                    </template>
                                </td>
                            </tr>
                            <tr hidden$="[[!machine.probe.ssh.users]]">
                                <td>Users</td>
                                <td>[[machine.probe.ssh.users]]</td>
                            </tr>
                            <tr hidden$="[[!machine.probe.ssh.uptime]]">
                                <td>Uptime</td>
                                <td>[[machine.probe.ssh.uptime]]</td>
                            </tr>
                            <tr class="change-dir" hidden$="[[!machine.probe.ssh.df]]">
                                <td class="change-dir">Filesystem Info</td>
                                <td class="change-dir">
                                    <div class="probe-df">
                                        <pre><code>[[machine.probe.ssh.df]]</code></pre>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </table>
                </div>
            </paper-material>
            <paper-material class="info-card" hidden$=[[!_hasExtra(machine)]]>
                <h2 style$="color:#fff;background-color: [[section.color]];">More Info</h2>
                <div class="card-content">
                    <element-for-in content="[[machine.extra]]"></element-for-in>
                </div>
            </paper-material>

            <paper-material class="machine-logs" hidden$=[[!count]]>
                <template is="dom-if" if=[[machine.machine_id]] restamp>
                    <mist-list id="machineLogs"
                        timeseries expands column-menu searchable streaming infinite toolbar auto-hide
                        apiurl="/api/v1/logs"
                        name="machine logs"
                        frozen=[[_getFrozenLogColumn()]]
                        visible=[[_getVisibleColumns()]]
                        renderers=[[_getRenderers(model.members)]]
                        primary-field-name="time"
                        base-filter="machine_id:[[machine.machine_id]]"></mist-list>
                </template>
            </paper-material>
        </div>
        <dialog-element id="machinedialog"></dialog-element>
        <iron-ajax  id="machineDeleteAjaxRequest"
                    url="/api/v1/machines/[[machine.id]]"
                    method="DELETE"
                    on-response="_handleMachineDeleteAjaxResponse"
                    on-error="_handleMachineDeleteAjaxError"></iron-ajax>

        <iron-ajax  id="disassociateKeyRequest"
                    url="/api/v1/machines/[[machine.id]]/keys/[[disassociateKeyId]]"
                    method="DELETE"
                    on-response="_disassociateKeyResponse"
                    on-error="_disassociateKeyError"
                    on-request="_disassociateKeyRequest"
                    handle-as="xml"></iron-ajax>

        <iron-ajax  id="probeMachine"
                    url="/api/v1/machines/[[machine.id]]/probe"
                    method="POST"
                    loading="{{probeLoading}}"
                    on-error="_probeError"
                    handle-as="xml"></iron-ajax>

        <paper-toast></paper-toast>
    </template>
</dom-module>
<script>
MACHINEACTIONS = {
  'shell': {
    'name': 'shell',
    'icon': 'vaadin-icons:terminal',
    'confirm': false,
    'multi': true
  },
  'tag': {
    'name': 'tag',
    'icon': 'label',
    'confirm': true,
    'multi': true
  },
  'run-script': {
    'name': 'run script',
    'icon': 'image:movie-creation',
    'confirm': true,
    'multi': false
  },
  'associate-key': {
    'name': 'associate key',
    'icon': 'communication:vpn-key',
    'confirm': true,
    'multi': true
  },
  'reboot': {
    'name': 'reboot',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'start': {
    'name': 'start',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'stop': {
    'name': 'stop',
    'icon': 'av:stop',
    'confirm': true,
    'multi': true
  },
  'suspend': {
    'name': 'suspend',
    'icon': 'av:stop',
    'confirm': true,
    'multi': true
  },
  'rename': {
    'name': 'rename',
    'icon': 'editor:mode-edit',
    'confirm': true,
    'multi': false
  },
  'resume': {
    'name': 'resume',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'undefine': {
    'name': 'undefine',
    'icon': 'image:panorama-fish-eye',
    'confirm': true,
    'multi': true
  },
  'destroy': {
    'name': 'destroy',
    'icon': 'delete',
    'confirm': true,
    'multi': true
  },
  'probe': {
    'name': 'probe',
    'icon': 'icons:compare-arrows',
    'confirm': false,
    'multi': true
  },
}

Polymer({
    is: 'machine-page',
    behaviors: [
        mistLoadingBehavior
    ],
    properties: {
        model: {
            type: Object
        },
        router: Object,
        uuid: {
            type: String
        },
        machine: {
            type: Object,
            computed: '_getMachine(uuid, model.machines.*)'
        },
        sections: {
            type: Array
        },
        section: {
            type: Object
        },
        tag: {
            type: String,
            value: ""
        },
        isMonitored: {
            type: Boolean,
            value: false
        },
        isActivated: {
            type: Boolean,
            value: false,
            computed: '_computeIsActivated(machine, model.monitoring.monitored_machines.*)'
        },
        machineName: {
            type: String,
            computed: "_computeMachineName(machine.*, model.machines.*)"
        },
        machineState: {
            type: String,
            computed: "_computeMachineState(machine.*, model.machines.*)"
        },
        machineSize: {
            type: String,
            computed: "_computeMachineSize(machine, machine.*, model.machines.*)"
        },
        dashboard: {
            type: Object
        },
        isLoading: {
            type: Boolean,
            computed: '_computeIsloading(machine)',
            value: true
        },
        newKeyId: {
            type: String,
            value: ''
        },
        machineIp: {
            type: String,
            computed: 'computeMachineIp(machine, machine.public_ips)'
        },
        disassociateKeyId: {
            type: String
        },
        isPendingKeyRequest: {
            type: Boolean
        },
        hideAssociatedKeys: {
            type: Boolean
        },
        machineKeys: {
            type: Array,
            computed: '_computeAssociatedKeys(machine, machine.key_associations, machine.key_associations.length, machine.*, model.machines.*, model.keys.*)',
            value: function(){
                return []
            },
            notify: true
        },
        itemUid: {
            type: Array,
            computed: '_computeThisItemUid(machine)'
        },
        actions: {
            type: Array,
            computed: '_computeActions(machine, machine.*, model.machines.*)'
        },
        dirtyCowAlert: {
             type: String,
             computed: '_computeDirtyCowAlert(machine)',
             value: false
         },
        hidden: {
            type: Boolean,
            value: false
        },
        machineLogFilter: {
            type: Object,
            computed: "_computeMachineLogFilter(machine)"
        },
        monitoring: {
            type: Boolean,
            value: false
        },
        itemArray: Array,
        actions: {
            type: Array,
            notify: true
        },
        r12ns: {
            type: Array,
            value: function() { return [] },
            computed: '_computeMachineR12ns(machine, model.notificationsArray.length)'
        }
    },
    observers: [
        '_isMonitored(machine, model.monitoring.machines.*)',
        '_machineChanged(machine.*, model.machines.*)',
        '_machineKeysChanged(machine, machine.key_associations, machine.key_associations.length, machine.*, model.machines.*, model.keys.*)'
    ],
    listeners: {
        'confirmation': '_machineActionConfirmation',
        'pending-key-request': '_updateKeyLoader',
        'select-action': 'selectAction'
    },
    ready: function() {
        this.set('hideAssociatedKeys', true);
        this.set('isPendingKeyRequest', false);
    },
    _getMachine: function(id, machines) {
        if (id && this.model && this.model.machines && this.model.machines[id]) 
            return this.model.machines[id];
    },
    _showRecommendationDialog: function(){
        this.fire("open-recommendation-dialog", {'item-type': 'machines', 'item': this.machine, 'caller': "machine_page"});
    },
    _computeActions: function(item) {
        var ret = [];
        if (item && ['running', 'unknown'].indexOf(item.state) > -1) {
            // if key then add shell / run script
            // if not monitoring then enable monitoring
            ret.push('shell');
            ret.push('associate-key');
            if(this.hideAssociatedKeys)
                ret.push('run-script');
        }
        if (item) {
            if (item.actions.tag)
                ret.push('tag');
            if (item.actions.start)
                ret.push('start');
            if (item.actions.stop)
                ret.push('stop');
            if (item.actions.suspend)
                ret.push('suspend');
            if (item.actions.reboot)
                ret.push('reboot');
            if (item.actions.resume)
                ret.push('resume');
            if (item.actions.rename)
                ret.push('rename');
            if (item.actions.destroy)
                ret.push('destroy');
            if (item.actions.undefine)
                ret.push('undefine');
        }

        var actions = [];
        for (var i = 0; i < ret.length; i++) {
            actions.push(MACHINEACTIONS[ret[i]]);
        }

        return actions;
    },
    _machineChanged: function(machine) {
        console.log('perform action machine changed', machine);
        if (this.machine)
            this.set('itemArray', [this.machine]);
    },
    _visibleKey: function(model,key) {
        if (model)
            return this.model.keys && this.model.keys[key.keypair];
    },
    _computeKeyName: function(keyid){
        if (this.model.keys[keyid])
            return this.model.keys[keyid].name || 'not found';
    },
    _computeThisItemUid: function(machine) {
        var itemUidInArray = [];
        itemUidInArray.push(itemUid(this.machine, this.model.sections['machines']));
        return itemUidInArray;
    },
    _computeAssociatedKeys: function(machine, keys, keyLength, machineChangeRecord) {
        return this.machine && this.machine.key_associations ? this.machine.key_associations : [];
    },
    displayArray: function(array) {
        if (array && array.length)
            return array.join(', ');
        return '';
    },
    computeMachineIp: function(machineips) {
        return this.machine.public_ips ? this.machine.public_ips[0] : '';
    },
    _isEqual: function(a, b) {
        return a === b;
    },
    _isMonitored: function(machine, monitoredMachines) {
        if (monitoredMachines) {
            var mach = monitoredMachines.base.find(function(m) {
                return m[1] == machine.id && m[0] == machine.cloud.id;
            }, this);
        }
        if (monitoredMachines && mach) {
            this.set('isMonitored', true);
        } else {
            this.set('isMonitored', false);
        }
    },
    _computeIsActivated: function(machine, monitoring){
        // console.log('_computeIsActivated', this.model.monitoring.monitored_machines[machine.id].installation_status.activated_at);
        if (!this.machine || !this.model.monitoring || !this.model.monitoring.monitored_machines || !this.model.monitoring.monitored_machines[machine.id] || !this.model.monitoring.monitored_machines[machine.id].installation_status.activated_at){
            return false;
        }
        else if (this.model && this.model.monitoring && this.model.monitoring.monitored_machines && this.model.monitoring.monitored_machines[machine.id] && this.model.monitoring.monitored_machines[machine.id].installation_status){
            return this.model.monitoring.monitored_machines[machine.id].installation_status.activated_at;
        }
    },
    _computeMachineName: function(machine) {
        return this.machine && this.machine.name || '';
    },
    _computeMachineState: function(machine) {
        return this.machine && this.machine.state || '';
    },
    confirmAction: function(action) {
        this._showDialog({
            title: action + ' Machine?',
            body: "You are about to " + action + " machine '" + this.machine.name + "'.",
            danger: false,
            reason: "machine." + action,
            action: action
        });
    },
    _showDialog: function(info) {
        var dialog = this.querySelector('#machinedialog');
        for (var i in info) {
            dialog[i] = info[i];
        }
        dialog._openDialog();
    },
    _showToast: function(msg) {
        var toast = this.querySelector('paper-toast');
        toast.text = msg;
        toast.show();
    },
    _hasExtraStatus: function(machine) {
        if (machine && machine.state && machine.extra.status)
            return machine.state.toLowerCase() == machine.extra.status.toLowerCase();
    },
    _computeExtraStatus: function(machine) {
        return machine && machine.extra && machine.extra.status && machine.extra.status.toLowerCase();
    },
    _computeIsloading: function(machine) {
        return !this.machine ? true : false;
    },
    disassociateKey: function(e) {
        var keyId = e.target['dataKeyid'];
        var keyName = e.target['dataKeyname'];

        this.set('disassociateKeyId', keyId);

        this._showDialog({
            title: 'Disassociate key',
            body: "Disassociating key '" + keyName + "' from machine, will remove the key from the machine.",
            danger: false,
            reason: "disassociate.key",
            action: 'disassociate',
            key: keyId
        });
    },
    _disassociateKeyRequest: function(e) {
        this.set('isPendingKeyRequest', true);
    },
    _disassociateKeyResponse: function(e) {
        this.set('isPendingKeyRequest', false);
        this.fire('toast',{msg:'Key was removed from machine!',duration:3000});
    },
    _disassociateKeyError: function(e) {
        this.set('isPendingKeyRequest', false);
        this.fire('toast',{msg:e.detail.request.xhr.responseText,duration:3000});
    },
    _machineActionConfirmation: function(e){
        if (e.detail.response.confirmed && e.detail.reason == "disassociate.key") {
            this.$.disassociateKeyRequest.headers["Csrf-Token"] = CSRF_TOKEN;
            this.$.disassociateKeyRequest.generateRequest();
        }
    },
    _updateKeyLoader: function(e) {
        if (e.detail.request) {
            this.set('isPendingKeyRequest', true);
        } else if (e.detail.response) {
            this.set('isPendingKeyRequest', false);
        } else if (e.detail.error) {
            this.set('isPendingKeyRequest', false);
            this.fire('toast',{msg:e.detail.errormsg,duration:3000});
        }
    },
    _feedbackOnScript: function(e) {
        if (e.detail.response) {
            this.fire('toast',{msg:'Script run request succeded. Script ' + this.model.scripts[e.detail.scriptId].name + ' has been queued for execution',duration:5000});
        }
        if (e.detail.error) {
            this.fire('toast',{msg:e.detail.errormsg,duration:3000});
        }
    },
    _feedbackOnRename: function(e) {
        if (e.detail.request) {
            this.fire('toast',{msg:'Rename request sent. Waiting for machine to respond',duration:3000});
        }
        if (e.detail.response) {
            this.fire('toast',{msg:'Renaming was successful.',duration:3000});
        }
        if (e.detail.error) {
            this.fire('toast',{msg:e.detail.errormsg,duration:3000});
        }
    },
    _computeDirtyCowAlert: function(machine){
         var info = "";
         if (this.machine && this.machine.probe && this.machine.probe.ssh && this.machine.probe.ssh.dirty_cow)
             info += "Dirty COW vulnerability detected. Update your kernel.";
         return info.length ? info : '';
    },
    _fromNow: function(time){
        return moment.utc(time).fromNow();
    },
    itemProbeClasses: function(machine) {
        if (!machine || !machine.probe) {
            return false;
        } else {
            if (!machine.probe.ssh || !machine.probe.ssh.loadavg) {
                return false;
            } else {
                var probe = machine.probe.ssh.loadavg;
                var cores =  parseInt(machine.probe.ssh.cores);
                var classes = '';
                var prefix = '';

                classes += this.loadToColor(parseFloat(probe[0]/cores), "short");
                classes += this.loadToColor(parseFloat(probe[1]/cores), "mid");
                classes += this.loadToColor(parseFloat(probe[2]/cores), "long");

                //has probe data
                if (classes != "")
                    classes += "hasprobe "

                return classes;
            }
        }
    },
    loadToColor: function(load, prefix){
        if (load > 1.2)
            return prefix+"high ";
        else if (load > 0.8)
            return prefix+"medium ";
        else if (load > 0.6)
            return prefix+"eco ";
        else if (load > 0.2)
            return prefix+"low ";
        else
            return prefix+"low ";
    },
    readableUptime: function(str){
        if (str) {
            var a = str.split(" ")[0],
                b = str.split(" ")[1];
            return "Up "+a+". Idle:"+b;
        }
        else
            return "";

    },
    _computeMachineImage: function(img){
        var item = this.machine;
        if (item && item.image && typeof(item.image) != "object"){
            return item.image;
        }
        else if (item && item.extra.image && typeof(item.extra.image) == "string") {
            return item.extra.image;
        }
        else if (item && item.extra.image && item.extra.image.distribution && item.extra.image.name) {
            return item.extra.image.distribution + " " + item.extra.image.name;
        }
        else if (item && item.extra && (item.extra['image_id'] || item.imageId || item.image_id || item.extra.image)){
            return item.extra['image_id'] || item.imageId || item.image_id || item.extra.image.slug || item.extra.image.name;
        }
        else
            return "not found";
    },
    _computeMachineSize: function(item, itemChangeRecord, machines) {
        // field could be in the 'extra' section, but should not be an object
        if (item) {
            var ret = item['size'];

            if (ret && typeof(ret) != 'object')
                return ret;
            if (!ret && item.extra && item.extra['size'] && typeof(item.extra['size']) != 'object')
                ret = item.extra['size'];
            if (item.extra && item.extra.size && item.extra.size.vcpus)
                return item.extra.size.vcpus + 'vcpu, ' + item.extra.size.memory + 'M ram';;
            if (item.extra && item.extra.size && typeof(item.extra.size) == 'string')
                return item.extra.size;
            if (item.extra && item.extra.instance_type)
                return item.extra.instance_type;
            if (item.extra && item.extra.instance_size)
                return item.extra.instance_size;
            if (item.extra && item.extra.maxCpu && item.extra.maxMemory)
                return item.extra.maxCpu + 'cpu, ' + item.extra.maxMemory + 'M ram';
            if (item.extra && item.extra.cpu && item.extra.memory)
                return item.extra.cpu + 'cpu, ' + item.extra.memory + 'M ram';
            if (item.extra && item.extra.PLANID) {
                var cloud = document.querySelector('mist-app').model.clouds[item.cloud.id];
                return (cloud && cloud.sizes) ? cloud.sizes[item.extra.PLANID].name + ": " + cloud.sizes[item.extra.PLANID].ram + " ram, " + cloud.sizes[item.extra.PLANID].disk + " disk, " + cloud.sizes[item.extra.PLANID].bandwidth + " bandwidth": item.extra.PLANID
            }
            if (item.extra && item.extra.service_type)
                return item.extra.service_type;
        }
        return '';
    },
    _probeMachine: function(e){
        var payload = {
            'key': this.machineKeys[0].keypair
        };
        this.$.probeMachine.headers["Csrf-Token"] = CSRF_TOKEN;
        this.$.probeMachine.params = payload;
        this.$.probeMachine.generateRequest();
        this.async(function(){
            this.notifyPath('machine.probe.ssh')
        }, 5000);
    },
    _probeError: function(e){
        this.fire('toast', { msg:'Error probing machine '+ e.detail.request.xhr.responseText, duration: 3000 });
    },
    _computeMachineLogFilter: function(machine) {
        if (machine)
            return {
                "cloud_id": machine.cloud.id,
                "machine_id": machine.machine_id
            }
    },
    _existsImage: function(extra) {
        if (extra)
            return extra.image || extra.image_id;
        return false;
    },
    _computeCloudIcon: function(cloud) {
        if (!cloud){
            return '';
        }
        else {
            console.log('cloud',cloud);
            return './assets/providers/provider-' + cloud.replace(/_/g, "") + '.png';
        }
    },
    _computeImageIcon: function(machine) {
        if (!machine){
            return false;
        }
        else {
            var image =  machine.extra.image_id || machine.operating_system || machine.operating_system_distro || machine.imageId || machine.os_type,
                imageIcon = "";
                image = image.toLowerCase();

            if (image.indexOf('ubuntu') != -1)
                imageIcon = "ubuntu";
            else if (image.indexOf('netbsd') != -1)
                imageIcon = "netbsd";
            else if (image.indexOf('freebsd') != -1)
                imageIcon = "freebsd";
            else if (image.indexOf('openbsd') != -1)
                imageIcon = "openbsd";
            else if (image.indexOf('alpine') != -1)
                imageIcon = "alpine";
            else if (image.indexOf('red hat') != -1)
                imageIcon = "red-hat";
            else if (image.indexOf('gentoo') != -1)
                imageIcon = "gentoo";
            else if (image.indexOf('arch') != -1)
                imageIcon = "arch";
            else if (image.indexOf('coreos') != -1)
                imageIcon = "coreos";
            else if (image.indexOf('mongo') != -1)
                imageIcon = "mongo";
            else if (image.indexOf('ami-') != -1)
                imageIcon = "aws";
            else if (image.indexOf('centos') != -1)
                imageIcon = "centos";
            else if (image.indexOf('debian') != -1)
                imageIcon = "debian";
            else if (image.indexOf('fedora') != -1)
                imageIcon = "fedora";
            else if (image.indexOf('suse') != -1)
                imageIcon = "suse";
            else if (image.indexOf('linux') != -1)
                imageIcon = "linux";
            else if (image.indexOf('windows') != -1)
                imageIcon = "windows";

            if (imageIcon.length)
                return './assets/image-icons/' + imageIcon + '.svg';
            else
                return false;
        }
    },

    _getVisibleColumns: function() {
        return ['type', 'action', 'user_id']
    },

    _getFrozenLogColumn: function() {
        return ['time']
    },

    _getRenderers: function() {
        var _this = this;
        return {
            'time': {
                'body': function(item, row) {
                    var ret = '<span title="' + moment(item*1000).format() + '">' + moment(item*1000).fromNow() + '</span>';
                    if (row.error)
                        ret += '<iron-icon icon="error" style="float: right"></iron-icon>';
                    return ret;
                }
            },
            'user_id': {
                'title': function(){ return 'user';},
                'body': function(item) {
                    if (_this.model && _this.model.members && item in _this.model.members &&
                        _this.model.members[item] && _this.model.members[item].name &&
                        _this.model.members[item].name != undefined){
                        var ret = '<a href="/members/' + item + '">' + _this.model.members[item].name + '</a>';
                        return ret;
                    } else console.log(item);
                    return item || '';
                }
            }
        };
    },

    _toFixed: function(inp) {
        return inp && inp.formatMoney() || '';
    },

    _hasExtra: function(machine) {
        if (this.machine && this.machine.extra)
            return Object.keys(this.machine.extra).length
        return false
    },

    _filterMachinesIncidents: function(incarray){
        if (this.model && this.model.incidentsArray)
            return this.model.incidentsArray.filter(function(inc){
                return this._isMachinesIncident(inc);
            }.bind(this));
    },

    _isMachinesIncident: function(inc) {
        if (this.machine)
            return this.machine.machine_id == inc.machine_id && this.machine.cloud.id == inc.cloud_id;
    },

    // redirect events
    selectAction: function(e) {
        e.stopImmediatePropagation();
        if (this.querySelector('machine-actions')) {
          this.querySelector('machine-actions').selectAction(e);
        }
    },

    // this should not be necessary, yet it is :(
    _machineKeysChanged: function(machineKeys) {
        this.$.machineKeysDomRepeat.render();
    },

    _computeMachineR12ns: function() {
        var ret = [], _this = this;
        if (this.machine && this.model.notificationsArray.length) {
            this.model.notificationsArray.forEach(function(i){
                if (i.machine && i.machine._ref.$id == _this.machine.id && i.machine._ref.$ref == 'machines' &&
                    i._cls == 'Notification.InAppNotification.InAppRecommendation'){
                    ret.push(i);
                }
            });
        }

        return ret;
    },

    _listToString: function(l) {
        return l && l.length && l.join(' ') || '';
    },

    _computePacketLossPercent: function(){
        if (!this.machine || !this.machine.probe || !this.machine.probe.ping)
            return 0;
        return 100* (this.machine.probe.ping.packets_loss / this.machine.probe.ping.packets_tx);
    },

    _computeProbeString: function() {
        var sshFrom = '',
            icmpFrom = '';
        if (!this.machine.probe)
            return;
        var sshLastUpdate = this.machine.probe.ssh && this.machine.probe.ssh.updated_at,
            icmpLastUpdate = this.machine.probe.ping && this.machine.probe.ping.updated_at;
        sshFrom = sshLastUpdate && moment.utc(sshLastUpdate).fromNow() || '';
        icmpFrom = icmpLastUpdate && moment.utc(icmpLastUpdate).fromNow() || '';
        if (!sshFrom && !icmpFrom)
            return '';
        if (sshFrom == icmpFrom)
            return sshFrom + ' over ssh & icmp';
        if (sshFrom && icmpFrom)
            return sshFrom + ' over ssh, ' + icmpFrom + ' over icmp';
        if (sshFrom)
            return sshFrom + ' over ssh';
        if (icmpFrom)
            return icmpFrom + ' over icmp';
    }
});
</script>
