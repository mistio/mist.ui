<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="mist-size-field.html">

<dom-module id="mist-machine-field">
    <template>
        <style include="shared-styles forms">
            :host {
                display: block;
                padding: 24px;
                border: 1px solid #eee  ;
                max-width: 100%;
                background-color: #f2f2f266;
            }

            :host>* {
                width: 100%;
            }

            paper-item.button-true {
                background-color: #2196F3 !important;
                font-weight: 500 !important;
                color: #fff !important;
                text-transform: uppercase;
            }
            paper-item.iron-selected {
                font-weight: normal;
            }
            paper-listbox {
                background: transparent;
                display: inline-block;
                vertical-align: top;
                max-height: 600px;
            }
            paper-input.search {
                padding-left: 16px;
                padding-right: 16px;
            }

            paper-checkbox {
                --paper-checkbox-checked-color: var(--mist-blue) !important;
                --paper-checkbox-checked-ink-color: var(--mist-blue) !important;
            }

            .fullwidth {
                width: 100%;
            }

            .title {
                text-transform: capitalize;
                font-weight: bold;
            }

            *[secondary] {
                opacity: .54;
            }

            .selected {
                margin-top: 24px;
            }

            @media (max-width: 991px) {
                paper-listbox {
                    padding: 38px 16px 16px 16px;
                }
            }
        </style>

        <div class="title">[[field.label]] machine</div>
        <paper-dropdown-menu label="[[field.label]] cloud" horizontal-align="left" disabled="[[field.disabled]]" 
            required="[[field.required]]">
            <paper-menu slot="dropdown-content" attr-for-selected="value" selected="{{field.cloud}}" class="dropdown-content">
                <template is="dom-if" if="[[_noOptions(clouds)]]" restamp>
                    <paper-item disabled>No clouds found</paper-item>
                </template>
                <template id="cloudsDomRepeat" is="dom-repeat" items="[[clouds]]" as="option">
                    <paper-item value="[[option.id]]" disabled$="[[option.disabled]]">
                        <span class="flex">[[_showOption(option)]]</span>
                    </paper-item>
                </template>
            </paper-menu>
        </paper-dropdown-menu>

        <p>
            <paper-toggle-button checked="{{useExistingMachine}}" hidden$="[[!field.cloud.length]]">
                <span hidden$="{{useExistingMachine}}"> Create [[field.label]] machine</span>
                <span hidden$="{{!useExistingMachine}}"> Use existing machine<span hidden$="!multi">s</span> as [[field.label]]</span>
            </paper-toggle-button>
        </p>

        <!-- if useExistingMachine -->
        <div hidden$="[[!useExistingMachine]]">
            <span class="selected" hidden$="[[!multi]]">
                <span hidden$="[[!field.machinesList.length]]">Selected:</span> <strong>[[_computeMachinesNames(field.machinesList,machines)]]</strong>
            </span>
        </div>
        <paper-dropdown-menu label="[[field.label]] machine" horizontal-align="left" disabled="[[field.disabled]]" 
            required="[[field.required]]" hidden$="[[!useExistingMachine]]">
            <paper-menu slot="dropdown-content" attr-for-selected="value" selected="{{field.machine}}" selected-items="{{field.machinesList}}" multi="[[multi]]" class="dropdown-content">
                <template is="dom-if" if="[[_noOptions(machines)]]" restamp>
                    <paper-item disabled>No machines found</paper-item>
                </template>
                <template id="machinesDomRepeat" is="dom-repeat" items="[[machines]]" as="option">
                    <paper-item value="[[option.machine_id]]" disabled$="[[option.disabled]]">
                        <span class="flex">[[_showOption(option)]]</span>
                    </paper-item>
                </template>
            </paper-menu>
        </paper-dropdown-menu>

        <!-- if !useExistingMachine -->
        <div hidden$="[[useExistingMachine]]">
            <div hidden$="[[!field.cloud.length]]">

                <paper-dropdown-menu label="[[field.label]] image" horizontal-align="left" disabled="[[field.disabled]]" class="fullwidth">
                    <div slot="dropdown-content" class="dropdown-content">
                        <paper-input class="search" label="Search images" value="{{imageSearchKeywords}}" hidden$="[[_noOptions(images)]]"></paper-input>
                        <paper-menu attr-for-selected="value" selected="{{field.image}}">
                            <template is="dom-if" if="[[_noOptions(images)]]" restamp>
                                <paper-item disabled>No images found</paper-item>
                            </template>
                            <template is="dom-repeat" items="[[_filter(images, imageSearchKeywords)]]" as="option">
                                <paper-item value="[[option.id]]" disabled$="[[option.disabled]]">
                                    <span class="flex">[[_showOption(option)]]</span>
                                </paper-item>
                            </template>
                        </paper-menu>
                    </div>
                </paper-dropdown-menu>

                <mist-size-field id$="app-form-[[id]]-[[field.name]]-size" field="{{fieldSize}}"></mist-size-field>

                <paper-dropdown-menu label="[[field.label]] key" horizontal-align="left" disabled="[[field.disabled]]" required="[[field.required]]">
                    <paper-menu slot="dropdown-content" attr-for-selected="value" selected="{{field.key}}" class="dropdown-content">
                        <template is="dom-if" if="[[_noOptions(keys)]]" restamp>
                            <paper-item disabled>No keys found</paper-item>
                        </template>
                        <template id="keysDomRepeat" is="dom-repeat" items="[[keys]]" as="option">
                            <paper-item value="[[option.id]]" disabled$="[[option.disabled]]">
                                <span class="flex">[[_showOption(option)]]</span>
                            </paper-item>
                        </template>
                    </paper-menu>
                </paper-dropdown-menu>

                <paper-dropdown-menu label="[[field.label]] location" horizontal-align="left" disabled="[[field.disabled]]" required="[[field.required]]">
                    <paper-menu slot="dropdown-content" attr-for-selected="value" selected="{{field.location}}" class="dropdown-content">
                        <template is="dom-if" if="[[_noOptions(locations)]]" restamp>
                            <paper-item disabled>No locations found</paper-item>
                        </template>
                        <template id="locationsDomRepeat" is="dom-repeat" items="[[locations]]" as="option">
                            <paper-item value="[[option.id]]" disabled$="[[option.disabled]]">
                                <span class="flex">[[_showOption(option)]]</span>
                            </paper-item>
                        </template>
                    </paper-menu>
                </paper-dropdown-menu>

                <paper-listbox>
                    <div>[[field.label]] network</div>
                    <template is="dom-if" if="[[_noOptions(networks)]]" restamp>
                        <p secondary>No networks found</p>
                    </template>
                    <template id="networksDomRepeat" is="dom-repeat" items="[[networks]]" as="option">
                        <paper-item>
                            <paper-checkbox name="network" on-change="_updateCheckboxesField" id$="[[option.id]]">
                                <template is="dom-if" if="[[option.img]]">
                                    <img class="item-img" src="[[option.img]]" width="24px"/>
                                </template>
                                <span class$="item-desc noimg-[[!option.img]]" data-prefix$=[[option.prefix]] data-suffix$=[[option.suffix]]>[[_showOption(option)]]</span>
                            </paper-checkbox>
                        </paper-item>
                    </template>
                </paper-listbox>

                <div hidden$="[[!multi]]">
                    <paper-input value="{{field.quantity}}" label="[[field.label]]s quantity" type="number"></paper-input>
                </div>

            </div>
        </div>

    </template>
    <script>
        Polymer({
            is: 'mist-machine-field',

            properties: {
                field: {
                    type: Object,
                    notify: true
                },
                clouds: {
                    type: Array,
                    value: []
                },
                machines: {
                    type: Array,
                    value: []
                },
                images: {
                    type: Array,
                    value: []
                },
                sizes: {
                    type: Array,
                    value: []
                },
                locations: {
                    type: Array,
                    value: []
                },
                keys: {
                    type: Array,
                    value: []
                },
                networks: {
                    type: Array,
                    value: []
                },
                multi: {
                    type: Boolean,
                    value: false
                },
                useExistingMachine: {
                    type: Boolean,
                    value: false
                },
                imageSearchKeywords: {
                    type: String,
                    value: ''
                },
                fieldSize: {
                    type: Object,
                    value: function(){
                        return {
                            label: 'size',
                            type: 'mist_size',
                            options: [],
                            custom: false,
                            value: '',
                            customValue: {},
                            customSizeFields: []
                        }
                    }
                }
            },

            listeners: {
            },
            observers: [
                '_fieldChanged(field)',
                '_fieldCloudsChanged(field, field.clouds, field.clouds.*)',
                '_fieldKeysChanged(field, field.keys, field.keys.*)',
                '_selectedCloudChanged(field.cloud)',
                '_fieldSizeChanged(fieldSize.value.*)',
                '_updateFieldValue(useExistingMachine, field.cloud, field.machine, field.machinesList, field.image, field.size, field.location, field.networks, field.key, field.quantity)'
            ],

            ready: function() {
                this.initializeValues();
            },

            initializeValues: function (cr) {
            },

            _fieldChanged: function(field) {
                this.set('fieldSize.label', this.field.label + ' size');
                this.set('multi', this.field.multi || false);
            },

            _fieldCloudsChanged: function(clouds) {
                this.set('clouds', this._objectToArray(this.field.clouds));
                this.$.cloudsDomRepeat.render();
            },

            _fieldSizeChanged: function(fieldSizeValue) {
                this.set('field.size_id', this.fieldSize.value == 'custom' ? this.fieldSize.customValue : this.fieldSize.value);
            },

            _fieldKeysChanged: function(keys) {
                this.set('keys', this._objectToArray(this.field.keys));
                this.$.keysDomRepeat.render();
            },

            _selectedCloudChanged: function(cloud) {
                if (this.field.cloud) {
                    var selectedCloud = this.field.clouds[this.field.cloud];
                    this.set('machines', this._objectToArray(selectedCloud.machines));
                    this.set('images', this._objectToArray(selectedCloud.images));
                    this.set('sizes', this._objectToArray(selectedCloud.sizes));
                    this.set('locations', this._objectToArray(selectedCloud.locations));
                    this.set('networks', this._objectToArray(selectedCloud.networks));

                    this.$.machinesDomRepeat.render();
                    this.$.locationsDomRepeat.render();
                    this.$.networksDomRepeat.render();

                    // update field consumed by mist-list
                    this.set('fieldSize.options', selectedCloud.sizesArray ? selectedCloud.sizesArray : [])
                    if (["onapp", "vsphere", "libvirt"].indexOf(selectedCloud.provider) > -1) {
                        var provider = selectedCloud.provider,
                            fields = MACHINE_CREATE_FIELDS.find(function(p) {return p.provider == provider}).fields;
                            this.set('fieldSize.custom', true)
                            this.set('fieldSize.value', "custom")
                            this.set('fieldSize.customSizeFields',fields.find(function(f){return f.type == "mist_size"}).customSizeFields)
                    } else {
                        this.set('fieldSize.custom', false)
                    }
                }
            },

            _updateFieldValue: function(useExistingMachine, cloud, machine, machineList, image, size, location, networks, key, quantity) {
                // console.log(useExistingMachine, cloud, machine, image, size, location, networks, key);
                if (this.useExistingMachine) {
                    if (this.multi) {
                        this.set('field.value', this.field.machinesList.map(function(f){return {cloud_id: this.field.cloud, machine_id: f.value} }.bind(this)));
                    } else {
                        this.set('field.value', {cloud_id: this.field.cloud, machine_id: this.field.machine})
                    }
                } else {
                    if (this.multi) {
                        this.set('field.value', {cloud_id: this.field.cloud,
                                            key_id: this.field.key,
                                            image_id: this.field.image,
                                            size_id: this.field.size_id,
                                            location_id: this.field.location,
                                            networks: this.field.networks,
                                            quantity: parseInt(this.field.quantity) || 1});
                    } else {
                        this.set('field.value', {cloud_id: this.field.cloud,
                                            key_id: this.field.key,
                                            image_id: this.field.image,
                                            size_id: this.field.size_id,
                                            location_id: this.field.location,
                                            networks: this.field.networks});
                    }
                }
                this.set('field.valid', this.validateValue());
                this.fire('field-value-changed');
            },

            validateValue: function(){
                if (this.useExistingMachine) {
                    if (this.multi) {
                        if (!this.field.value.length){
                            // console.log('machine')
                            return false;
                        }
                    } else {
                        if (!this.field.value.cloud_id) {
                            // console.log('cloud')
                            return false;
                        }
                        if (!this.field.value.machine_id){
                            // console.log('machine')
                            return false;
                        }
                    }
                } else if (!this.useExistingMachine) {
                    if (!this.field.value.cloud_id) {
                            // console.log('cloud')
                            return false;
                        }
                    if (!this.field.value.image_id){
                        // console.log('machine');
                        return false;
                    }
                    if (!this.field.value.key_id){
                        // console.log('key');
                        return false;
                    }
                    if (!this.field.value.size_id){
                        // console.log('size', value.size_id);
                        return false;
                    }
                    if (!this.field.value.location_id){
                        // console.log('location');
                        return false;
                    }
                }
                return true;
            },

            _noOptions: function (options) {
                return !options || options.length == 0;
            },

            _showOption: function (option) {
                if (option.name) {
                    return option.name;
                } else if (option.title) {
                    return option.title;
                } else if (option.id) {
                    return option.id;
                }
            },

            _filter: function (options, search) {
                return options.filter(function (op) {
                    return op.name.toLowerCase().indexOf(search.toLowerCase()) > -1;
                });
            },

            _objectToArray: function(obj) {
                var arr = [];
                for (var p in obj) {
                    arr.push(obj[p]);
                }
                return arr;
            },

            _updateCheckboxesField: function (e) {
                var fieldNetworks = this.get('field.networks') || [];
                if (e.target.checked && fieldNetworks.indexOf(e.model.option.id) == -1){
                    fieldNetworks.push(e.model.option.id);
                } else if (!e.target.checked && fieldNetworks.indexOf(e.model.option.id) > -1){
                    fieldNetworks.splice(fieldNetworks.indexOf(e.model.option.id),1)
                }
                this.set('field.networks', fieldNetworks);
            },

            _computeMachinesNames: function(machinesList, machines) {
                return !machinesList ? 'select' :  machinesList.map(function(m){return this._getName(m.value, machines);}.bind(this))
            },

            _getName: function(m, machines) {
                var machine = this.machines && this.machines.find(function(item){ return item.machine_id == m});
                return machine ? machine.name : 'not found';
            }

        });
    </script>
</dom-module>